<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herramienta de Evaluación - Festival Agripina</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script type="module">
        console.log("SCRIPT MODULE STARTING..."); // NEW: First line in the module script

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        console.log("Firebase modules imported successfully."); // NEW: After imports

        const firebaseConfig = {
          apiKey: "AIzaSyA0hy5PZwHw9hdkVnPqLNkztGeghk-j1s4", 
          authDomain: "agripina-evaluador.firebaseapp.com",
          projectId: "agripina-evaluador",
          storageBucket: "agripina-evaluador.firebasestorage.app",
          messagingSenderId: "651959986582",
          appId: "1:651959986582:web:beab2a64a4553b9c31d5b7"
        };
        const appId = firebaseConfig.projectId; // Usamos el projectId como appId para la ruta de Firestore

        let app, db, auth; // Declare these variables here

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            console.log("Firebase app and services initialized.");
        } catch (e) {
            console.error("Error initializing Firebase app or services:", e);
            document.getElementById('userIdDisplay').textContent = `Error de inicialización de Firebase: ${e.message}. Verifica tu configuración.`;
        }

        window.db = db; // Assign to window object
        window.auth = auth; // Assign to window object
        window.userId = null;
        window.isAuthReady = false;
        window.appId = appId; // Make appId globally accessible

        console.log("Firebase services assigned to window object.");

        // Listener para el estado de autenticación de Firebase
        if (window.auth) { // Only attach listener if auth was successfully initialized
            onAuthStateChanged(window.auth, async (user) => {
                if (user) {
                    window.userId = user.uid;
                    console.log("Firebase Auth: Usuario autenticado. ID:", window.userId);
                } else {
                    console.log("Firebase Auth: No hay usuario autenticado. Intentando inicio de sesión anónimo...");
                    try {
                        await signInAnonymously(window.auth);
                        window.userId = window.auth.currentUser.uid;
                        console.log("Firebase Auth: Inicio de sesión anónimo exitoso. ID:", window.userId);
                    } catch (error) {
                        console.error("Firebase Auth: Error al iniciar sesión anónimamente:", error);
                        document.getElementById('userIdDisplay').textContent = `Error de autenticación: ${error.message}. Verifica tu configuración de Firebase y las reglas de seguridad.`;
                    }
                }
                window.isAuthReady = true;
                document.getElementById('userIdDisplay').textContent = `Tu ID: ${window.userId}`;
                document.dispatchEvent(new CustomEvent('firebaseAuthReady'));
                console.log("Firebase Auth: Evento 'firebaseAuthReady' despachado.");
            });
        } else {
            console.error("Firebase Auth no se inicializó correctamente, no se pudo adjuntar onAuthStateChanged.");
            document.getElementById('userIdDisplay').textContent = `Error crítico: Firebase Auth no disponible.`;
        }

        // Exportar funciones de Firebase para que sean accesibles globalmente
        window.getFirestore = getFirestore;
        window.doc = doc;
        window.setDoc = setDoc;
        window.onSnapshot = onSnapshot;
        window.collection = collection;
        window.query = query;
        window.getDocs = getDocs;
        window.getDoc = getDoc;

        // Moved DOMContentLoaded listener to be the first thing after global assignments
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOMContentLoaded: DOM completamente cargado."); // This should now appear if the script runs at all
            renderCriteria();
            createRadarChart();
            createBarChart();
            
            // Poblar el selector de trabajos inmediatamente con los datos iniciales
            populateWorkSelector(); 

            workSelector.addEventListener('change', onWorkSelectorChange);
            saveVoteBtn.addEventListener('click', saveVote);
            saveWorkDetailsBtn.addEventListener('click', saveWorkDetails);
            showEvaluationBtn.addEventListener('click', () => showPanel('evaluation'));
            showGlobalResultsBtn.addEventListener('click', () => showPanel('globalResults'));

            document.addEventListener('firebaseAuthReady', () => {
                console.log("firebaseAuthReady: Evento recibido. Iniciando carga de datos de Firebase.");
                fetchAndPopulateAllWorkDetails();
                setupGlobalResultsListener();
                setupWorkDetailsListener();
            });

            showPanel('evaluation');
        });
    </script>
</head>
<body class="antialiased">
    <!-- NUEVO SCRIPT DE PRUEBA: ESTO DEBERÍA APARECER SIEMPRE EN LA CONSOLA -->
    <script>
        console.log("¡SCRIPT BÁSICO EN BODY FUNCIONANDO!");
    </script>
    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-7xl">
        <header class="text-center mb-10">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Herramienta de Evaluación de Proyectos</h1>
            <p class="text-lg text-gray-600 mt-2">Festival Agripina - Categoría Estudiantes</p>
            <p id="userIdDisplay" class="text-sm text-gray-500 mt-2">Cargando ID de usuario...</p>
        </header>

        <div class="bg-white/60 backdrop-blur-sm p-6 sm:p-8 rounded-2xl shadow-lg border border-gray-200/50 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Seleccionar y Editar Trabajo</h2>
            <div class="flex flex-col sm:flex-row items-center gap-4 mb-4">
                <label for="workSelector" class="text-lg font-semibold text-gray-700">Trabajo:</label>
                <select id="workSelector" class="flex-grow px-4 py-2 rounded-lg border border-gray-300 bg-white text-gray-800 shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    <!-- Options will be populated by JS -->
                </select>
            </div>
            <div class="space-y-4 mb-6">
                <div>
                    <label for="workCustomNameInput" class="block text-sm font-medium text-gray-700 mb-1">Nombre del Trabajo:</label>
                    <input type="text" id="workCustomNameInput" placeholder="Ej: Proyecto Final Publicidad" class="w-full px-4 py-2 rounded-lg border border-gray-300 bg-white text-gray-800 shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="ideaNameInput" class="block text-sm font-medium text-gray-700 mb-1">Nombre de la Idea:</label>
                    <input type="text" id="ideaNameInput" placeholder="Ej: Campaña 'EcoFuturo'" class="w-full px-4 py-2 rounded-lg border border-gray-300 bg-white text-gray-800 shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="brandNameInput" class="block text-sm font-medium text-gray-700 mb-1">Marca:</label>
                    <input type="text" id="brandNameInput" placeholder="Ej: GreenTech Solutions" class="w-full px-4 py-2 rounded-lg border border-gray-300 bg-white text-gray-800 shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
            <button id="saveWorkDetailsBtn" class="w-full px-6 py-3 rounded-xl bg-blue-600 text-white font-semibold hover:bg-blue-700 transition-colors shadow-md">
                Guardar Detalles del Trabajo
            </button>
            <p id="workDetailsStatus" class="mt-4 text-center text-sm text-gray-600"></p>
        </div>

        <nav class="flex justify-center space-x-4 mb-10">
            <button id="showEvaluation" class="px-6 py-3 rounded-xl bg-blue-700 text-white font-semibold hover:bg-blue-800 transition-colors shadow-md">
                Mi Votación
            </button>
            <button id="showGlobalResults" class="px-6 py-3 rounded-xl bg-gray-200 text-gray-700 font-semibold hover:bg-gray-300 transition-colors shadow-md">
                Resultados Globales
            </button>
        </nav>

        <main>
            <div id="evaluationPanel" class="bg-white/60 backdrop-blur-sm p-6 sm:p-8 rounded-2xl shadow-lg border border-gray-200/50 mb-12">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Bienvenido, profesorado</h2>
                <p class="text-gray-700 leading-relaxed">
                    Esta herramienta interactiva está diseñada para facilitar la evaluación de las piezas de los estudiantes según los criterios oficiales del Festival Agripina. Utilice los controles deslizantes para puntuar cada categoría. El gráfico y el resumen se actualizarán en tiempo real para proporcionar una visión clara y comparable de cada proyecto, ayudando a tomar una decisión informada para la selección final.
                </p>
            </div>

            <div id="evaluationContent" class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12">
                <div id="evaluation-criteria" class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg border border-gray-200/50">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6">Panel de Evaluación</h3>
                    <!-- Criteria will be rendered here by JS -->
                    <button id="saveVoteBtn" class="mt-8 w-full px-6 py-3 rounded-xl bg-green-600 text-white font-semibold hover:bg-green-700 transition-colors shadow-md">
                        Guardar Votación
                    </button>
                    <p id="saveStatus" class="mt-4 text-center text-sm text-gray-600"></p>
                </div>

                <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg border border-gray-200/50 flex flex-col justify-center items-center">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4 text-center">Perfil Visual de Mi Votación</h3>
                    <div class="chart-container">
                        <canvas id="radarChart"></canvas>
                    </div>
                    <div class="mt-6 text-center bg-blue-50 p-6 rounded-xl w-full">
                        <h4 class="text-lg font-semibold text-gray-700">Mi Puntuación Total</h4>
                        <p id="totalScore" class="text-5xl font-bold text-blue-800 mt-2">0</p>
                    </div>
                </div>
            </div>

            <div id="globalResultsContent" class="hidden mt-12 bg-white p-6 sm:p-8 rounded-2xl shadow-lg border border-gray-200/50">
                <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">Resultados Globales de Votaciones</h3>
                <p class="text-gray-700 leading-relaxed mb-8 text-center">
                    Aquí puedes ver el promedio de las puntuaciones de todos los profesores para el trabajo seleccionado. Este gráfico se actualiza en tiempo real a medida que se registran nuevas votaciones.
                </p>
                <div class="bar-chart-container">
                    <canvas id="barChart"></canvas>
                </div>
                <div class="mt-6 text-center bg-purple-50 p-6 rounded-xl w-full">
                    <h4 class="text-lg font-semibold text-gray-700">Puntuación Media Global</h4>
                    <p id="globalAverageScore" class="text-5xl font-bold text-purple-800 mt-2">0.0</p>
                    <p class="text-gray-600 mt-2">Basado en <span id="numVotes">0</span> votaciones</p>
                </div>
            </div>
        </main>
         <footer class="text-center py-10 mt-8">
            <p class="text-gray-500">Diseñado como herramienta de apoyo para la selección de piezas del Festival Agripina.</p>
            <div class="mt-4 text-gray-600 space-y-2">
                <p>Ejemplos de ganadores y piezas inscritas:</p>
                <ul class="list-none p-0 space-y-1">
                    <li>
                        <a href="https://premiosagripina.es/coca-cola-disfruta-de-lo-autentico/" target="_blank" rel="noopener noreferrer" class="text-blue-700 hover:text-blue-900 font-semibold underline">
                            Coca-Cola: Disfruta de lo auténtico
                        </a>
                    </li>
                    <li>
                        <a href="https://premiosagripina.es/category/categorias-profesionales/estudiante/" target="_blank" rel="noopener noreferrer" class="text-blue-700 hover:text-blue-900 font-semibold underline">
                            Categoría Estudiante - Ejemplos Adicionales
                        </a>
                    </li>
                     <li>
                        <a href="https://premiosagripina.es/festival-agripina-premios-2023/" target="_blank" rel="noopener noreferrer" class="text-blue-700 hover:text-blue-900 font-semibold underline">
                            Festival Agripina Premios 2023
                        </a>
                    </li>
                     <li>
                        <a href="https://premiosagripina.es/ganadores-2022/" target="_blank" rel="noopener noreferrer" class="text-blue-700 hover:text-blue-900 font-semibold underline">
                            Ganadores 2022
                        </a>
                    </li>
                    <li>
                        <a href="https://elenacasasespejo.com/toysagainstanxiety/" target="_blank" rel="noopener noreferrer" class="text-blue-700 hover:text-blue-900 font-semibold underline">
                            Toys Against Anxiety
                        </a>
                    </li>
                </ul>
            </div>
        </footer>
    </div>
</body>
</html>
