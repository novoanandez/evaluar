<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herramienta de Evaluación - Festival Agripina</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script type="module">
        console.log("SCRIPT MODULE STARTING..."); // NEW: First line in the module script

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        console.log("Firebase modules imported successfully."); // NEW: After imports

        const firebaseConfig = {
          apiKey: "AIzaSyA0hy5PZwHw9hdkVnPqLNkztGeghk-j1s4", 
          authDomain: "agripina-evaluador.firebaseapp.com",
          projectId: "agripina-evaluador",
          storageBucket: "agripina-evaluador.firebasestorage.app",
          messagingSenderId: "651959986582",
          appId: "1:651959986582:web:beab2a64a4553b9c31d5b7"
        };
        const appId = firebaseConfig.projectId; // Usamos el projectId como appId para la ruta de Firestore

        let app, db, auth; // Declare these variables here

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            console.log("Firebase app and services initialized.");
        } catch (e) {
            console.error("Error initializing Firebase app or services:", e);
            document.getElementById('userIdDisplay').textContent = `Error de inicialización de Firebase: ${e.message}. Verifica tu configuración.`;
        }

        window.db = db; // Assign to window object
        window.auth = auth; // Assign to window object
        window.userId = null;
        window.isAuthReady = false;
        window.appId = appId; // Make appId globally accessible

        console.log("Firebase services assigned to window object.");

        // Listener para el estado de autenticación de Firebase
        if (window.auth) { // Only attach listener if auth was successfully initialized
            onAuthStateChanged(window.auth, async (user) => {
                if (user) {
                    window.userId = user.uid;
                    console.log("Firebase Auth: Usuario autenticado. ID:", window.userId);
                } else {
                    console.log("Firebase Auth: No hay usuario autenticado. Intentando inicio de sesión anónimo...");
                    try {
                        await signInAnonymously(window.auth);
                        window.userId = window.auth.currentUser.uid;
                        console.log("Firebase Auth: Inicio de sesión anónimo exitoso. ID:", window.userId);
                    } catch (error) {
                        console.error("Firebase Auth: Error al iniciar sesión anónimamente:", error);
                        document.getElementById('userIdDisplay').textContent = `Error de autenticación: ${error.message}. Verifica tu configuración de Firebase y las reglas de seguridad.`;
                    }
                }
                window.isAuthReady = true;
                document.getElementById('userIdDisplay').textContent = `Tu ID: ${window.userId}`;
                document.dispatchEvent(new CustomEvent('firebaseAuthReady'));
                console.log("Firebase Auth: Evento 'firebaseAuthReady' despachado.");
            });
        } else {
            console.error("Firebase Auth no se inicializó correctamente, no se pudo adjuntar onAuthStateChanged.");
            document.getElementById('userIdDisplay').textContent = `Error crítico: Firebase Auth no disponible.`;
        }

        // Exportar funciones de Firebase para que sean accesibles globalmente
        window.getFirestore = getFirestore;
        window.doc = doc;
        window.setDoc = setDoc;
        window.onSnapshot = onSnapshot;
        window.collection = collection;
        window.query = query;
        window.getDocs = getDocs;
        window.getDoc = getDoc;

        // Moved DOMContentLoaded listener to be the first thing after global assignments
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOMContentLoaded: DOM completamente cargado."); // This should now appear if the script runs at all
            renderCriteria();
            createRadarChart();
            createBarChart();
            
            // Poblar el selector de trabajos inmediatamente con los datos iniciales
            populateWorkSelector(); 

            workSelector.addEventListener('change', onWorkSelectorChange);
            saveVoteBtn.addEventListener('click', saveVote);
            saveWorkDetailsBtn.addEventListener('click', saveWorkDetails);
            showEvaluationBtn.addEventListener('click', () => showPanel('evaluation'));
            showGlobalResultsBtn.addEventListener('click', () => showPanel('globalResults'));

            document.addEventListener('firebaseAuthReady', () => {
                console.log("firebaseAuthReady: Evento recibido. Iniciando carga de datos de Firebase.");
                fetchAndPopulateAllWorkDetails();
                setupGlobalResultsListener();
                setupWorkDetailsListener();
            });

            showPanel('evaluation');
        });
    </script>
</body>
</html>
```

### **Pasos Cruciales a Seguir Después de Actualizar el Código:**

1.  **Guarda los cambios en GitHub:** Asegúrate de que el contenido de tu `index.html` en GitHub sea **exactamente** el del Canvas actualizado.
2.  **Espera unos minutos:** Dale tiempo a GitHub Pages para que despliegue los cambios.
3.  **Abre tu página web y las herramientas de desarrollador:**
    * Ve a `https://novoanandez.github.io/evaluador/` en tu navegador.
    * Haz clic derecho en cualquier parte de la página y selecciona **"Inspeccionar"** o **"Inspeccionar elemento"**.
4.  **Ve a la pestaña "Network" (Red):**
    * **Asegúrate de que la opción "Disable cache" (Deshabilitar caché) esté marcada.**
    * **Recarga la página forzadamente:** `Ctrl + Shift + R` (Windows/Linux) o `Cmd + Shift + R` (macOS).
    * Observa la lista de archivos. **¿Hay alguna entrada en rojo?** Si la hay, por favor, copia y pega la línea completa del error (incluyendo el "Status" como `404`, `CORS`, etc.).
5.  **Vuelve a la pestaña "Console" (Consola):**
    * Después de revisar "Network", cambia a "Console".
    * **Asegúrate de que no haya filtros aplicados** (selecciona "All" o "Verbose").
    * **¡Copia y pega aquí TODO el contenido de la consola!** Incluso si solo ves "SCRIPT MODULE STARTING...", eso ya es una pista. Si aparece algún error en rojo, es lo más importante.

**Además, por favor, re-confirma estos dos puntos en Firebase, ya que son la causa más común de problemas de autenticación/guardado:**

* **1. Autenticación Anónima Habilitada:**
    * [Consola de Firebase](https://console.firebase.google.com/) > Tu proyecto > **Build > Authentication > Sign-in method**. Asegúrate de que **"Anonymous"** esté **habilitado**.
* **2. Reglas de Seguridad de Firestore Correctas:**
    * [Consola de Firebase](https://console.firebase.google.com/) > Tu proyecto > **Build > Firestore Database > Rules**. Asegúrate de que sean exactamente estas:
        ```firestore
        rules_version = '2';
        service cloud.firestore {
          match /databases/{database}/documents {
            // Permite lectura y escritura a cualquier usuario autenticado en la colección agripina_work_details
            match /artifacts/{appId}/public/data/agripina_work_details/{document=**} {
              allow read, write: if request.auth != null;
            }
            // Permite lectura y escritura a cualquier usuario autenticado en las subcolecciones de agripina_votes_by_work
            match /artifacts/{appId}/public/data/agripina_votes_by_work/{workId}/votes/{userId} {
              allow read, write: if request.auth != null;
            }
          }
        }
        ```
    * Haz clic en **"Publish"** si haces cambios.

Con esta nueva información de la consola y la red, estoy seguro de que podremos identificar el problema. ¡No te des por venci
